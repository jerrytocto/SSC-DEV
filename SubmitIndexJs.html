<script>
  function enviarform(event, form) {
    // Acción evita que se muestre una hoja en blanco al enviar el formulario
    event.preventDefault();

    // Verificar si hay productos agregados
    const productListJson = document.getElementById('productListJson').value;
    const totalCompra = parseFloat(document.getElementById('totalCompra').value.replace(/[^\d.-]/g, '')) || 0; // limpiamos símbolo $
    const requiereCapex = document.getElementById('requiereCapex').value;

    // Validamos si se añadieron productos a la SC
    if (!productListJson || JSON.parse(productListJson).length === 0) {
      // No hay productos, mostrar mensaje de error
      const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
      const modalMessage = document.getElementById("modalMessage");

      modalMessage.innerHTML = `
            <div class="text-center">
                <i class="bi bi-exclamation-circle-fill text-warning" style="font-size: 2rem;"></i>
                <p class="mt-2">Debe agregar al menos un producto antes de enviar el formulario.</p>
            </div>
        `;
      resultModal.show();
      return; // Detiene la ejecución de la función
    }



    // Mostrar modal de advertencia antes de continuar
    const confirmSendModal = new bootstrap.Modal(document.getElementById('confirmSendModal'));

    const confirmSendBody = document.querySelector('#confirmSendModal .modal-body');

    let contenidoAdicional = '';

    // Formatear a USD
    const formattedTotalUSD = totalCompra.toLocaleString('en-US', {
      style: 'currency',
      currency: 'USD'
    });

    // Mostrar solo si requiereCapex está activado y el total supera los 1000 USD
    if (requiereCapex === 'SI' && totalCompra > 1000) {
      contenidoAdicional = `
      <div class="text-center mt-3 p-3 border rounded" style="background-color: #f0f0f0; color: #333;">
         Dado que el total de esta solicitud es de <strong>${formattedTotalUSD}</strong>, superando el umbral de <strong>$1,000.00</strong>, 
          y considerando que incluye la adquisición de activo(s), 
          es obligatorio que <strong>toda la información ingresada esté redactada en inglés</strong>.
      </div>
      `;
    }

    // Insertar el contenido del modal
    confirmSendBody.innerHTML = `
    <p class="text-center">
      <i class="bi bi-exclamation-triangle-fill" style="font-size: 2rem; color: #ffc107;"></i>
    </p>
    <p class="text-center mt-2">
      Asegúrese de que los precios de los productos estén expresados en <strong>dólares</strong>.<br>
      ¿Desea continuar con el envío?
    </p>
    ${contenidoAdicional}
  `;



    confirmSendModal.show();

    // Cuando el usuario confirme desde el modal, se hace el envío real
    const confirmSendBtn = document.getElementById('confirmSendBtn');

    // Importante: remover event listeners anteriores para evitar múltiples envíos
    confirmSendBtn.replaceWith(confirmSendBtn.cloneNode(true));
    const newConfirmSendBtn = document.getElementById('confirmSendBtn');

    newConfirmSendBtn.addEventListener("click", function () {
      confirmSendModal.hide();
      procesarEnvio(form); // Enviar de verdad
    });
  }

  function procesarEnvio(form) {
    const button = document.getElementById("btn-submit");
    const modalMessage = document.getElementById("modalMessage");
    const processingModal = new bootstrap.Modal(document.getElementById('processingModal'));
    const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));

    processingModal.show();
    button.disabled = true;

    google.script.run
      .withSuccessHandler(fileUrl => {
        processingModal.hide();
        modalMessage.innerHTML = `
        <div class="text-center">
          <i class="bi bi-check-circle-fill text-success" style="font-size: 2rem;"></i>
          <p class="mt-2">${fileUrl}</p>
        </div>
      `;
        resultModal.show();
        clearProductModal();
        button.disabled = false;

        // Limpiar campos
        document.getElementById('razonCompra').selectedIndex = 0;
        document.getElementById('inputState').selectedIndex = 0;
        document.getElementById('file').value = '';
        document.getElementById('justificacion').value = '';
        document.getElementById('observaciones').value = '';
        document.getElementById('justifyCompraProd').value = '';

        const productTable = document.getElementById('productTable');
        if (productTable) productTable.innerHTML = '';

        const hiddenInputs = ['justifyCompraProds'];
        hiddenInputs.forEach(id => {
          const element = document.getElementById(id);
          if (element) element.value = '';
        });

      })
      .withFailureHandler(error => {
        processingModal.hide();
        modalMessage.innerHTML = `
        <div class="text-center">
          <i class="bi bi-x-circle-fill text-danger" style="font-size: 2rem;"></i>
          <p class="mt-2">Algo salió mal: ${error.message}</p>
        </div>
      `;
        resultModal.show();
        clearProductModal();
        button.disabled = false;
      })
      .uploadFiles(form);
  }



  // Configuración de eventos para el modal de resultado
  const resultModal = document.getElementById('resultModal');

  // Manejar el foco y la accesibilidad al mostrar el modal
  resultModal.addEventListener('show.bs.modal', function () {
    // Desenfocar cualquier elemento activo
    if (document.activeElement) {
      document.activeElement.blur();
    }
  });

  resultModal.addEventListener('shown.bs.modal', function () {
    // Establecer el foco en el botón de cierre
    const closeButton = this.querySelector('.btn-close');
    if (closeButton) {
      closeButton.focus();
    }
  });

  // Modificar el evento hidden.bs.modal para verificar si fue un envío exitoso
  resultModal.addEventListener('hidden.bs.modal', function () {
    // Limpiar cualquier foco residual
    this.querySelectorAll('button, a, input').forEach(el => {
      el.blur();
    });

    // Verificar si el mensaje en el modal es de éxito
    const modalMessage = document.getElementById("modalMessage");
    const isSuccess = modalMessage.querySelector('.text-success');

    // Solo recargar si fue un envío exitoso
    if (isSuccess) {
      window.location.reload(true);
    }
  });

  // Modificar los manejadores de eventos para los botones de cierre
  document.getElementById('closeResultModalBtn').addEventListener('click', function () {
    const modalMessage = document.getElementById("modalMessage");
    const isSuccess = modalMessage.querySelector('.text-success');

    if (isSuccess) {
      window.location.reload(true);
    }
  });

  document.getElementById('closeResultModalFooterBtn').addEventListener('click', function () {
    const modalMessage = document.getElementById("modalMessage");
    const isSuccess = modalMessage.querySelector('.text-success');

    if (isSuccess) {
      location.replace(location.href);
    }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous">
  </script>